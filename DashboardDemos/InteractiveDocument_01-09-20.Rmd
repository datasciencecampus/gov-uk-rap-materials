---
title: "An interactive document"
author: "Joseph Crispell"
date: "`r format(Sys.Date(), '%d %b %Y')`"
output:
  html_document:
    number_sections: true
    toc: yes
    toc_depth: '2'
    toc_float: yes
---

```{r setup, include=FALSE}

# By default show code chunks in output
knitr::opts_chunk$set(echo=TRUE)

# Load the required libraries
library(plotly) # Interative plots
library(kableExtra) # Extra nice tables
library(RColorBrewer) # Creating colour pallettes
library(DT) # An interactive table format
```

```{r functions, echo=FALSE}

# Function to build simple scrollable table for html output
prettyTable <- function(table){
  
  # Use the kable function to create a nicer formatted table
  kable(table, row.names=FALSE) %>%
  
    # Set the format
    kable_styling(bootstrap_options="striped", # Set the colour of rows
                  full_width=FALSE, # Make the table not stretch to fit the page
                  position="left") %>% # Position the table on the left
  
    # Make the table scrollable
    scroll_box(height = "400px")
}

# Function to align the data for a particular count by date
alignCountByDate <- function(data, countColumn){
  
  # Initialise a dataframe to store the aligned data - a row for each date data from any country available
  alignedByDate <- data.frame(Date=sort(unique(covid$Date_reported)), check.names=FALSE)

  # Using dates as unique row names as some countries don't have data for every date
  rownames(alignedByDate) <- as.character(alignedByDate$Date)

  # Add the death counts for each country
  for(country in unique(covid$Country)){
  
    # Create a column for the current country
    alignedByDate[, country] <- NA
    
    # Get the data for current country
    counts <- covid[covid$Country == country, c("Date_reported", countColumn)]
    
    # Insert the countries data into the aligned table - note using date as the row index
    alignedByDate[as.character(counts$Date_reported), country] <- counts[, countColumn]
  }
  
  return(alignedByDate)
}

# Function to identify top X countries based on latest values in particular count column
getTopCountries <-function(covid, countColumn, n){
  
  # Get the latest date that data available for 
  latestDate <- max(covid$Date_reported)
  
  # Get the latest count values
  latestCounts <- covid[covid$Date_reported == latestDate, c("Country", countColumn)]
  
  # Order the counts from highest to smallest
  latestCounts <- latestCounts[order(latestCounts[, countColumn], decreasing=TRUE), ]
  
  # Return the top "n" countries
  return(latestCounts$Country[1:n])
}
```


# Introduction

The current document aims to illustrate how we can used [Rmarkdown](https://rmarkdown.rstudio.com/) to create interactive documents for visualising and exploring data. We'll be exploring the [COVID-19](https://covid19.who.int/) data published by the World Health Organisation.

# Downloading the data

The World Health Organisation publishes COVID-19 case and death counts for most countries. We can load these data with the following code:

```{r load the data}

# Note the url for the WHO COVID-19 data
whoURL <- "https://covid19.who.int/WHO-COVID-19-global-data.csv"

# Load the WHO COVID-19 data
covid <- read.csv(whoURL)

# Fix the first column name
colnames(covid)[1] <- "Date_reported"

# Convert the dates from character vector to a date object
covid$Date_reported <- as.Date(covid$Date_reported, format="%Y-%m-%d")
```

The WHO COVID-19 data looks like this:
```{r view WHO data, echo=FALSE}
# Take a quick look at the table - note I am limiting view to first 25 rows
prettyTable(covid[1:25, ])
```

# Processing the data

The WHO data reports the new and cumulative counts for cases and deaths for each country since the start of January. We want to visualise the daily trends in deaths for each country, so we'll need to manipulate the data a little to align the daily deaths counts by date (*note that I am using a bespoke function to do this processing*):
```{r align by date}
# Align the daily death counts by date
alignedByDate <- alignCountByDate(covid, countColumn="New_deaths")
```

The aligned data looks like this:
```{r view aligned data, echo=FALSE}
# Take a quick look at the aligned deaths data - note only selecting 25 rows and 25 countries
prettyTable(alignedByDate[100:125, 1:25])
```

# Plotting the data

With the aligned data, we can now create an interactive plot for the daily deaths counts in each country. Here we've written code to view the daily death trends in the 5 countries with the highest cumulative totals
```{r plot the daily deaths}
# Select the countries with the highest cumulative death counts
nToSelect <- 5
topCountries <- getTopCountries(covid, countColumn="Cumulative_deaths", n=nToSelect)

# Define a colour palette
colours <- colorRampPalette(brewer.pal(8, "Dark2"))(nToSelect)

# Create the initial plotly figure
fig <- plot_ly()
  
# Add a trace for the rolling average dataset
for(i in seq_along(topCountries)){
  fig <- add_lines(fig, 
                   x=alignedByDate$Date, y=alignedByDate[, topCountries[i]], 
                   name=topCountries[i], 
                   hovertemplate=paste("Number deaths:", alignedByDate[, topCountries[i]]),
                   line=list(color=colours[i]))
}

# Set the X axis label
fig <- layout(fig, xaxis=list(title="Date"))

# Set the Y axis label
fig <- layout(fig, yaxis=list(title="Number deaths per day"))

# Set the plot title
fig <- layout(fig, title=paste0("Trends in daily deaths in top ", nToSelect, " countries with highest total deaths"))

# Plot the final figure
fig
```

# Providing the data

We can use the [DT](https://rstudio.github.io/DT/) package to provide an interactive version of the aligned data used to create the plot above  (*Note that for the first few months many of the top countries didn't report any COVID-19 deaths*):

```{r interactive table}
datatable(alignedByDate[, c("Date", topCountries)], rownames=FALSE)
```

# Some useful resources

Here's some resources that I found useful when creating this dashboard:

- [Getting started with Rmarkdown](https://rmarkdown.rstudio.com/lesson-1.html)
- [Rmarkdown cheatsheet](https://rstudio.com/wp-content/uploads/2015/02/rmarkdown-cheatsheet.pdf)
- [Interactive plotting with plotly](https://plotly.com/r/)
- [Programming in R](https://www.tutorialspoint.com/r/index.htm)
- [Troubleshooting with stackoverflow](https://stackoverflow.com/questions/tagged/r)
